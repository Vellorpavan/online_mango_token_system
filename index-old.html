<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mango Factory Token System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // Tailwind config
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mango: {
              50: '#fff7ed',
              100: '#ffedd5',
              200: '#fed7aa',
              300: '#fdba74',
              400: '#fb923c',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
              800: '#9a3412',
              900: '#7c2d12',
            }
          },
          fontFamily: {
            display: ['Georgia', 'serif'],
            body: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
      min-height: 100vh;
    }

    /* Animations */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .animate-slideUp {
      animation: slideUp 0.4s ease-out;
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }

    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #fff7ed;
    }

    ::-webkit-scrollbar-thumb {
      background: #fb923c;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #f97316;
    }

    /* Status badges */
    .status-pending {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fbbf24;
    }

    .status-approved {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }

    .status-completed {
      background: #e0e7ff;
      color: #3730a3;
      border: 1px solid #6366f1;
    }

    /* Card hover effect */
    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- 1. Native Firebase Module -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, query, where, orderBy, limit, Timestamp, addDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA5BhjfnsHxaTlonJsJWhOcaxfE3D0G35M",
      authDomain: "project-98786.firebaseapp.com",
      projectId: "project-98786",
      storageBucket: "project-98786.firebasestorage.app",
      messagingSenderId: "937525981527",
      appId: "1:937525981527:web:22bb7edfef415176f94e12",
      measurementId: "G-BD71TRXPFY"
    };

    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.firebaseAuth = auth;
      window.firebaseDb = db;
      window.firebaseUtils = {
        auth, db, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut,
        collection, doc, getDoc, getDocs, setDoc, updateDoc, query, where, orderBy, limit, Timestamp, addDoc, deleteDoc
      };
      window.dispatchEvent(new Event('firebase-ready'));
    } catch (e) {
      console.error('Firebase Setup Error:', e);
    }
  </script>

  <!-- React Application -->
  <script type="text/babel" data-type="module">
    const { useState, useEffect, useRef } = React;

    // ==================== UTILITY FUNCTIONS ====================

    const calculateDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371; // Radius of Earth in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    };

    const generateTokenNumber = (factoryCode, date, sequence) => {
      const dateStr = date.replace(/-/g, '');
      const seqStr = String(sequence).padStart(3, '0');
      return `${factoryCode}-${dateStr}-${seqStr}`;
    };

    const formatPhoneNumber = (phone) => {
      if (!phone) return '';
      const cleaned = phone.replace(/\D/g, '');
      const match = cleaned.match(/^(\d{2})(\d{5})(\d{3})(\d{2})$/);
      if (match) {
        return `+${match[1]} ${match[2]} XXX ${match[4]}`;
      }
      return phone;
    };

    const calculateEstimatedTime = (openingTime, queuePosition) => {
      const avgProcessingMinutes = 30;
      const [hours, minutes] = openingTime.split(':').map(Number);
      const estimatedMinutes = hours * 60 + minutes + (queuePosition - 1) * avgProcessingMinutes;
      const estimatedHours = Math.floor(estimatedMinutes / 60);
      const estimatedMins = estimatedMinutes % 60;
      return `${String(estimatedHours).padStart(2, '0')}:${String(estimatedMins).padStart(2, '0')}`;
    };

    // ==================== AUTHENTICATION COMPONENT ====================

    function LoginScreen({ onLoginSuccess }) {
      const [phoneNumber, setPhoneNumber] = useState('');
      const [otp, setOtp] = useState('');
      const [step, setStep] = useState('phone'); // 'phone' or 'otp'
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [confirmationResult, setConfirmationResult] = useState(null);
      const recaptchaRef = useRef(null);

      useEffect(() => {
        if (!recaptchaRef.current && window.FB) {
          window.recaptchaVerifier = new window.FB.RecaptchaVerifier(
            window.FB.auth,
            'recaptcha-container',
            {
              size: 'invisible',
              callback: () => { }
            }
          );
          recaptchaRef.current = true;
        }
      }, []);

      const handleDeveloperBypass = async (role) => {
        const mockUser = { uid: 'DEV_USER_' + role, phoneNumber: '+910000000000' };
        const mockData = { name: 'Demo ' + role, role: role, phoneNumber: '+910000000000' };

        // Ensure user document exists in Firestore for permissions
        try {
          await window.firebaseUtils.setDoc(
            window.firebaseUtils.doc(window.firebaseDb, 'users', mockUser.uid),
            { ...mockData, createdAt: window.firebaseUtils.Timestamp.now() },
            { merge: true }
          );
        } catch (err) {
          console.error('Bypass Setup Error:', err);
        }

        onLoginSuccess(mockUser, mockData);
      };

      const handleSendOtp = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        const phoneRegex = /^[6-9]\d{9}$/;
        if (!phoneRegex.test(phoneNumber)) {
          setError('Please enter a valid 10-digit number');
          setLoading(false);
          return;
        }

        const fullPhone = '+91' + phoneNumber;

        try {
          const result = await window.firebaseUtils.signInWithPhoneNumber(
            window.firebaseAuth,
            fullPhone,
            window.recaptchaVerifier
          );
          setConfirmationResult(result);
          setStep('otp');
        } catch (err) {
          setError('Failed: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleVerifyOtp = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          const result = await confirmationResult.confirm(otp);
          const user = result.user;

          const userDoc = await window.firebaseUtils.getDoc(
            window.firebaseUtils.doc(window.firebaseDb, 'users', user.uid)
          );

          if (!userDoc.exists()) {
            onLoginSuccess(user, null);
          } else {
            onLoginSuccess(user, userDoc.data());
          }
        } catch (err) {
          setError('Invalid OTP.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md animate-slideUp">
            <div className="text-center mb-8">
              <div className="w-20 h-20 bg-gradient-to-br from-mango-400 to-mango-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                <span className="text-4xl">ü•≠</span>
              </div>
              <h1 className="text-3xl font-display font-bold text-gray-800 mb-2">Mango Factory</h1>
              <p className="text-gray-600">Token Management System</p>
            </div>

            {error && (
              <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                {error}
              </div>
            )}

            {step === 'phone' ? (
              <form onSubmit={handleSendOtp}>
                <div className="mb-6">
                  <label className="block text-gray-700 font-medium mb-2">Phone Number</label>
                  <div className="relative">
                    <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">+91</span>
                    <input
                      type="tel"
                      value={phoneNumber}
                      onChange={(e) => setPhoneNumber(e.target.value.replace(/\D/g, '').slice(0, 10))}
                      placeholder="XXXXXXXXXX"
                      className="w-full pl-14 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mango-500 font-bold"
                      required
                    />
                  </div>
                  <p className="text-sm text-gray-500 mt-2">Enter 10 digit number</p>
                </div>
                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-gradient-to-r from-mango-500 to-mango-600 text-white py-3 rounded-lg font-semibold hover:from-mango-600 hover:to-mango-700 transition-all disabled:opacity-50"
                >
                  {loading ? 'Sending OTP...' : 'Send OTP'}
                </button>
              </form>
            ) : (
              <form onSubmit={handleVerifyOtp}>
                <div className="mb-6">
                  <label className="block text-gray-700 font-medium mb-2">Enter OTP</label>
                  <input
                    type="text"
                    value={otp}
                    onChange={(e) => setOtp(e.target.value)}
                    placeholder="123456"
                    maxLength="6"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mango-500 text-center text-2xl tracking-widest"
                    required
                  />
                  <p className="text-sm text-gray-500 mt-1">Sent to {formatPhoneNumber(phoneNumber)}</p>
                </div>
                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-gradient-to-r from-mango-500 to-mango-600 text-white py-3 rounded-lg font-semibold hover:from-mango-600 hover:to-mango-700 transition-all disabled:opacity-50 mb-3"
                >
                  {loading ? 'Verifying...' : 'Verify OTP'}
                </button>
                <button
                  type="button"
                  onClick={() => setStep('phone')}
                  className="w-full text-gray-600 py-2 hover:text-gray-800"
                >
                  Change Phone Number
                </button>
              </form>
            )}

            <div id="recaptcha-container"></div>

            {/* Development Tools */}
            <div className="mt-8 pt-6 border-t border-gray-100">
              <p className="text-[10px] text-gray-500 text-center uppercase tracking-widest font-bold mb-4">Development Tools (Bypass OTP)</p>
              <div className="grid grid-cols-3 gap-2">
                <button onClick={() => handleDeveloperBypass('farmer')} className="bg-orange-50 text-orange-600 py-2 rounded-lg text-xs font-bold hover:bg-orange-100 transition-colors">Farmer</button>
                <button onClick={() => handleDeveloperBypass('factory')} className="bg-orange-50 text-orange-600 py-2 rounded-lg text-xs font-bold hover:bg-orange-100 transition-colors">Factory</button>
                <button onClick={() => handleDeveloperBypass('admin')} className="bg-orange-50 text-orange-600 py-2 rounded-lg text-xs font-bold hover:bg-orange-100 transition-colors">Admin</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ==================== REGISTRATION COMPONENT ====================

    function RegistrationScreen({ user, onRegistrationComplete }) {
      const [name, setName] = useState('');
      const [role, setRole] = useState('farmer');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleRegister = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          const userData = {
            phoneNumber: user.phoneNumber,
            name,
            role,
            createdAt: window.firebaseUtils.Timestamp.now()
          };

          await window.firebaseUtils.setDoc(
            window.firebaseUtils.doc(window.firebaseDb, 'users', user.uid),
            userData
          );

          onRegistrationComplete(userData);
        } catch (err) {
          console.error('Registration Error:', err);
          setError('Failed to register. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md animate-slideUp">
            <h2 className="text-2xl font-display font-bold text-gray-800 mb-6">Complete Registration</h2>

            {error && (
              <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                {error}
              </div>
            )}

            <form onSubmit={handleRegister}>
              <div className="mb-4">
                <label className="block text-gray-700 font-medium mb-2">Full Name</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Enter your name"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mango-500"
                  required
                />
              </div>

              <div className="mb-6">
                <label className="block text-gray-700 font-medium mb-2">I am a</label>
                <select
                  value={role}
                  onChange={(e) => setRole(e.target.value)}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mango-500"
                >
                  <option value="farmer">Farmer</option>
                  <option value="factory">Factory User</option>
                  <option value="admin">Admin</option>
                </select>
              </div>

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-gradient-to-r from-mango-500 to-mango-600 text-white py-3 rounded-lg font-semibold hover:from-mango-600 hover:to-mango-700 transition-all disabled:opacity-50"
              >
                {loading ? 'Registering...' : 'Complete Registration'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // ==================== FARMER DASHBOARD ====================

    function FarmerDashboard({ user, userData }) {
      const [activeTab, setActiveTab] = useState('factories');
      const [factories, setFactories] = useState([]);
      const [tokens, setTokens] = useState([]);
      const [loading, setLoading] = useState(true);
      const [userLocation, setUserLocation] = useState(null);

      useEffect(() => {
        loadFactories();
        loadTokens();
        getUserLocation();
      }, []);

      const getUserLocation = () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setUserLocation({
                lat: position.coords.latitude,
                lng: position.coords.longitude
              });
            },
            (error) => {
              console.log('Location error:', error);
            }
          );
        }
      };

      const loadFactories = async () => {
        try {
          const factoriesRef = window.firebaseUtils.collection(window.firebaseDb, 'factories');
          const q = window.firebaseUtils.query(
            factoriesRef,
            window.firebaseUtils.where('isActive', '==', true)
          );
          const snapshot = await window.firebaseUtils.getDocs(q);
          const factoryList = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setFactories(factoryList);
        } catch (err) {
          console.error('Load Factories Error:', err);
        } finally {
          setLoading(false);
        }
      };

      const loadTokens = async () => {
        try {
          const tokensRef = window.firebaseUtils.collection(window.firebaseDb, 'tokens');
          const q = window.firebaseUtils.query(
            tokensRef,
            window.firebaseUtils.where('farmerId', '==', user.uid),
            window.firebaseUtils.orderBy('createdAt', 'desc'),
            window.firebaseUtils.limit(20)
          );
          const snapshot = await window.firebaseUtils.getDocs(q);
          const tokenList = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setTokens(tokenList);
        } catch (err) {
          console.error('Load Tokens Error:', err);
        }
      };

      const handleLogout = async () => {
        await window.firebaseUtils.signOut(window.firebaseAuth);
        window.location.reload();
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-mango-50 to-orange-50">
          {/* Header */}
          <header className="bg-white shadow-md sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <div className="flex items-center gap-3">
                <span className="text-3xl">ü•≠</span>
                <div>
                  <h1 className="text-xl font-bold text-gray-800">Mango Factory</h1>
                  <p className="text-sm text-gray-600">Welcome, {userData.name}</p>
                </div>
              </div>
              <button
                onClick={handleLogout}
                className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition"
              >
                Logout
              </button>
            </div>
          </header>

          {/* Tabs */}
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex gap-2 mb-6">
              <button
                onClick={() => setActiveTab('factories')}
                className={`flex-1 py-3 rounded-lg font-semibold transition ${activeTab === 'factories'
                  ? 'bg-mango-500 text-white'
                  : 'bg-white text-gray-700 hover:bg-gray-50'
                  }`}
              >
                üè≠ Factories
              </button>
              <button
                onClick={() => setActiveTab('tokens')}
                className={`flex-1 py-3 rounded-lg font-semibold transition ${activeTab === 'tokens'
                  ? 'bg-mango-500 text-white'
                  : 'bg-white text-gray-700 hover:bg-gray-50'
                  }`}
              >
                üé´ My Tokens
              </button>
            </div>

            {/* Content */}
            {loading ? (
              <div className="text-center py-20">
                <div className="animate-pulse text-mango-500 text-4xl mb-4">ü•≠</div>
                <p className="text-gray-600">Loading...</p>
              </div>
            ) : activeTab === 'factories' ? (
              <FactoryList
                factories={factories}
                userLocation={userLocation}
                user={user}
                userData={userData}
                onTokenCreated={loadTokens}
              />
            ) : (
              <TokenList tokens={tokens} onRefresh={loadTokens} />
            )}
          </div>
        </div>
      );
    }

    // Factory List Component
    function FactoryList({ factories, userLocation, user, userData, onTokenCreated }) {
      const [selectedFactory, setSelectedFactory] = useState(null);

      const factoriesWithDistance = factories.map(factory => {
        let distance = null;
        if (userLocation && factory.location) {
          distance = calculateDistance(
            userLocation.lat,
            userLocation.lng,
            factory.location.lat,
            factory.location.lng
          );
        }
        return { ...factory, distance };
      }).sort((a, b) => {
        if (a.distance === null) return 1;
        if (b.distance === null) return -1;
        return a.distance - b.distance;
      });

      if (selectedFactory) {
        return (
          <BookingForm
            factory={selectedFactory}
            user={user}
            userData={userData}
            onBack={() => setSelectedFactory(null)}
            onSuccess={onTokenCreated}
          />
        );
      }

      return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {factoriesWithDistance.map(factory => (
            <div
              key={factory.id}
              className="bg-white rounded-xl shadow-md p-6 card-hover cursor-pointer"
              onClick={() => setSelectedFactory(factory)}
            >
              <h3 className="text-xl font-bold text-gray-800 mb-3">{factory.name}</h3>
              <div className="space-y-2 text-sm text-gray-600">
                <p className="flex items-center gap-2">
                  üìç {factory.address}
                </p>
                {factory.distance && (
                  <p className="flex items-center gap-2">
                    üìè {factory.distance.toFixed(1)} km away
                  </p>
                )}
                <p className="flex items-center gap-2">
                  ‚è∞ {factory.openingTime} - {factory.closingTime}
                </p>
                <p className="flex items-center gap-2">
                  üìä Daily Capacity: {factory.dailyCapacity} farmers
                </p>
              </div>
              <button className="mt-4 w-full bg-mango-500 text-white py-2 rounded-lg hover:bg-mango-600 transition">
                Book Token
              </button>
            </div>
          ))}
        </div>
      );
    }

    // Booking Form Component
    function BookingForm({ factory, user, userData, onBack, onSuccess }) {
      const [quantity, setQuantity] = useState('');
      const [mangoType, setMangoType] = useState('Alphonso');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState(false);

      const handleBookToken = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          const today = new Date().toLocaleDateString('en-CA');

          // Check for existing token
          const tokensRef = window.firebaseUtils.collection(window.firebaseDb, 'tokens');
          const existingQuery = window.firebaseUtils.query(
            tokensRef,
            window.firebaseUtils.where('farmerId', '==', user.uid),
            window.firebaseUtils.where('factoryId', '==', factory.id),
            window.firebaseUtils.where('date', '==', today)
          );
          const existingSnapshot = await window.firebaseUtils.getDocs(existingQuery);

          if (!existingSnapshot.empty) {
            setError('You already have a token for this factory today!');
            setLoading(false);
            return;
          }

          // Get today's token count
          const todayQuery = window.firebaseUtils.query(
            tokensRef,
            window.firebaseUtils.where('factoryId', '==', factory.id),
            window.firebaseUtils.where('date', '==', today)
          );
          const todaySnapshot = await window.firebaseUtils.getDocs(todayQuery);
          const todayCount = todaySnapshot.size;

          if (todayCount >= factory.dailyCapacity) {
            setError('Factory capacity reached for today. Please try tomorrow.');
            setLoading(false);
            return;
          }

          // Generate token
          const factoryCode = factory.name.substring(0, 2).toUpperCase() + '001';
          const tokenNumber = generateTokenNumber(factoryCode, today, todayCount + 1);
          const queuePosition = todayCount + 1;
          const estimatedTime = calculateEstimatedTime(factory.openingTime, queuePosition);

          const tokenData = {
            tokenNumber,
            farmerId: user.uid,
            farmerPhone: user.phoneNumber,
            farmerName: userData.name,
            factoryId: factory.id,
            factoryName: factory.name,
            date: today,
            status: 'pending',
            queuePosition,
            estimatedTime,
            quantity: parseInt(quantity),
            mangoType,
            createdAt: window.firebaseUtils.Timestamp.now(),
            updatedAt: window.firebaseUtils.Timestamp.now()
          };

          await window.firebaseUtils.addDoc(tokensRef, tokenData);
          setSuccess(true);
          setTimeout(() => {
            onSuccess();
            onBack();
          }, 2000);

        } catch (err) {
          console.error('Token Booking Error:', err);
          setError('Failed to book token. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      if (success) {
        return (
          <div className="bg-white rounded-xl shadow-md p-8 text-center animate-fadeIn">
            <div className="text-6xl mb-4">‚úÖ</div>
            <h2 className="text-2xl font-bold text-green-600 mb-2">Token Booked Successfully!</h2>
            <p className="text-gray-600">Redirecting...</p>
          </div>
        );
      }

      return (
        <div className="bg-white rounded-xl shadow-md p-6 animate-slideUp">
          <button onClick={onBack} className="text-gray-600 hover:text-gray-800 mb-4">
            ‚Üê Back to Factories
          </button>

          <h2 className="text-2xl font-bold text-gray-800 mb-4">Book Token</h2>
          <div className="bg-mango-50 p-4 rounded-lg mb-6">
            <h3 className="font-bold text-gray-800">{factory.name}</h3>
            <p className="text-sm text-gray-600">{factory.address}</p>
          </div>

          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
              {error}
            </div>
          )}

          <form onSubmit={handleBookToken}>
            <div className="mb-4">
              <label className="block text-gray-700 font-medium mb-2">Quantity (kg)</label>
              <input
                type="number"
                value={quantity}
                onChange={(e) => setQuantity(e.target.value)}
                min="1"
                max="1000"
                placeholder="Enter quantity in kg"
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mango-500"
                required
              />
            </div>

            <div className="mb-6">
              <label className="block text-gray-700 font-medium mb-2">Mango Type</label>
              <select
                value={mangoType}
                onChange={(e) => setMangoType(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mango-500"
              >
                <option value="Alphonso">Alphonso</option>
                <option value="Kesar">Kesar</option>
                <option value="Dasheri">Dasheri</option>
                <option value="Langra">Langra</option>
                <option value="Chausa">Chausa</option>
                <option value="Totapuri">Totapuri</option>
                <option value="Banganapalli">Banganapalli</option>
              </select>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-gradient-to-r from-mango-500 to-mango-600 text-white py-3 rounded-lg font-semibold hover:from-mango-600 hover:to-mango-700 transition-all disabled:opacity-50"
            >
              {loading ? 'Booking...' : 'Confirm Booking'}
            </button>
          </form>
        </div>
      );
    }

    // Token List Component
    function TokenList({ tokens, onRefresh }) {
      if (tokens.length === 0) {
        return (
          <div className="bg-white rounded-xl shadow-md p-12 text-center">
            <div className="text-6xl mb-4">üé´</div>
            <h3 className="text-xl font-bold text-gray-800 mb-2">No Tokens Yet</h3>
            <p className="text-gray-600">Book your first token from the Factories tab!</p>
          </div>
        );
      }

      return (
        <div className="space-y-4">
          {tokens.map(token => (
            <div key={token.id} className="bg-white rounded-xl shadow-md p-6 animate-fadeIn">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h3 className="text-xl font-bold text-gray-800">{token.tokenNumber}</h3>
                  <p className="text-sm text-gray-600">{token.factoryName}</p>
                </div>
                <span className={`px-3 py-1 rounded-full text-sm font-semibold status-${token.status}`}>
                  {token.status.toUpperCase()}
                </span>
              </div>

              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <p className="text-gray-600">Queue Position</p>
                  <p className="font-bold text-gray-800 text-lg">#{token.queuePosition}</p>
                </div>
                <div>
                  <p className="text-gray-600">Estimated Time</p>
                  <p className="font-bold text-gray-800 text-lg">{token.estimatedTime}</p>
                </div>
                <div>
                  <p className="text-gray-600">Quantity</p>
                  <p className="font-bold text-gray-800">{token.quantity} kg</p>
                </div>
                <div>
                  <p className="text-gray-600">Mango Type</p>
                  <p className="font-bold text-gray-800">{token.mangoType}</p>
                </div>
              </div>

              <div className="mt-4 pt-4 border-t border-gray-200">
                <p className="text-xs text-gray-500">
                  Booked on {new Date(token.createdAt.seconds * 1000).toLocaleDateString()}
                </p>
              </div>
            </div>
          ))}
        </div>
      );
    }

    // ==================== FACTORY DASHBOARD ====================

    function FactoryDashboard({ user, userData }) {
      const [tokens, setTokens] = useState([]);
      const [factory, setFactory] = useState(null);
      const [activeTab, setActiveTab] = useState('pending');
      const [loading, setLoading] = useState(true);
      const [stats, setStats] = useState({ pending: 0, approved: 0, completed: 0 });

      useEffect(() => {
        loadFactory();
      }, []);

      useEffect(() => {
        if (factory) {
          loadTokens();
        }
      }, [factory, activeTab]);

      const loadFactory = async () => {
        try {
          const factoryDoc = await window.firebaseUtils.getDoc(
            window.firebaseUtils.doc(window.firebaseDb, 'factories', userData.factoryId)
          );
          if (factoryDoc.exists()) {
            setFactory({ id: factoryDoc.id, ...factoryDoc.data() });
          }
        } catch (err) {
          console.error('Load Factory Error:', err);
        } finally {
          setLoading(false);
        }
      };

      const loadTokens = async () => {
        try {
          const today = new Date().toLocaleDateString('en-CA');
          const tokensRef = window.firebaseUtils.collection(window.firebaseDb, 'tokens');

          let q;
          if (activeTab === 'all') {
            q = window.firebaseUtils.query(
              tokensRef,
              window.firebaseUtils.where('factoryId', '==', factory.id),
              window.firebaseUtils.where('date', '==', today),
              window.firebaseUtils.orderBy('queuePosition', 'asc')
            );
          } else {
            q = window.firebaseUtils.query(
              tokensRef,
              window.firebaseUtils.where('factoryId', '==', factory.id),
              window.firebaseUtils.where('date', '==', today),
              window.firebaseUtils.where('status', '==', activeTab),
              window.firebaseUtils.orderBy('queuePosition', 'asc')
            );
          }

          const snapshot = await window.firebaseUtils.getDocs(q);
          const tokenList = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setTokens(tokenList);

          // Calculate stats
          const allTokensQuery = window.firebaseUtils.query(
            tokensRef,
            window.firebaseUtils.where('factoryId', '==', factory.id),
            window.firebaseUtils.where('date', '==', today)
          );
          const allSnapshot = await window.firebaseUtils.getDocs(allTokensQuery);
          const pending = allSnapshot.docs.filter(d => d.data().status === 'pending').length;
          const approved = allSnapshot.docs.filter(d => d.data().status === 'approved').length;
          const completed = allSnapshot.docs.filter(d => d.data().status === 'completed').length;
          setStats({ pending, approved, completed });

        } catch (err) {
          console.error('Load Tokens Error:', err);
        }
      };

      const handleUpdateStatus = async (tokenId, newStatus) => {
        try {
          const tokenRef = window.firebaseUtils.doc(window.firebaseDb, 'tokens', tokenId);
          const updateData = {
            status: newStatus,
            updatedAt: window.firebaseUtils.Timestamp.now()
          };

          if (newStatus === 'completed') {
            updateData.completedAt = window.firebaseUtils.Timestamp.now();
          }

          await window.firebaseUtils.updateDoc(tokenRef, updateData);
          loadTokens();
        } catch (err) {
          console.error('Update Status Error:', err);
        }
      };

      const handleLogout = async () => {
        await window.firebaseUtils.signOut(window.firebaseAuth);
        window.location.reload();
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="animate-pulse text-mango-500 text-4xl">ü•≠</div>
          </div>
        );
      }

      if (!factory) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-md p-8 text-center">
              <h2 className="text-xl font-bold text-gray-800 mb-4">No Factory Assigned</h2>
              <p className="text-gray-600">Please contact admin to assign you to a factory.</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
          {/* Header */}
          <header className="bg-white shadow-md sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <div>
                <h1 className="text-xl font-bold text-gray-800">{factory.name}</h1>
                <p className="text-sm text-gray-600">Factory Dashboard</p>
              </div>
              <button
                onClick={handleLogout}
                className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition"
              >
                Logout
              </button>
            </div>
          </header>

          <div className="max-w-7xl mx-auto px-4 py-6">
            {/* Stats */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div className="bg-white rounded-xl shadow-md p-6">
                <p className="text-gray-600 text-sm">Today's Total</p>
                <p className="text-3xl font-bold text-gray-800">{stats.pending + stats.approved + stats.completed}</p>
              </div>
              <div className="bg-yellow-50 rounded-xl shadow-md p-6">
                <p className="text-yellow-800 text-sm">Pending</p>
                <p className="text-3xl font-bold text-yellow-600">{stats.pending}</p>
              </div>
              <div className="bg-green-50 rounded-xl shadow-md p-6">
                <p className="text-green-800 text-sm">Approved</p>
                <p className="text-3xl font-bold text-green-600">{stats.approved}</p>
              </div>
              <div className="bg-blue-50 rounded-xl shadow-md p-6">
                <p className="text-blue-800 text-sm">Completed</p>
                <p className="text-3xl font-bold text-blue-600">{stats.completed}</p>
              </div>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 mb-6 overflow-x-auto">
              {['pending', 'approved', 'completed', 'all'].map(tab => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={`px-6 py-3 rounded-lg font-semibold whitespace-nowrap transition ${activeTab === tab
                    ? 'bg-blue-600 text-white'
                    : 'bg-white text-gray-700 hover:bg-gray-50'
                    }`}
                >
                  {tab.charAt(0).toUpperCase() + tab.slice(1)}
                </button>
              ))}
            </div>

            {/* Tokens List */}
            <div className="space-y-4">
              {tokens.length === 0 ? (
                <div className="bg-white rounded-xl shadow-md p-12 text-center">
                  <p className="text-gray-600">No {activeTab} tokens found.</p>
                </div>
              ) : (
                tokens.map(token => (
                  <div key={token.id} className="bg-white rounded-xl shadow-md p-6 animate-fadeIn">
                    <div className="flex justify-between items-start mb-4">
                      <div>
                        <h3 className="text-xl font-bold text-gray-800">{token.tokenNumber}</h3>
                        <p className="text-sm text-gray-600">{token.farmerName}</p>
                        <p className="text-xs text-gray-500">{formatPhoneNumber(token.farmerPhone)}</p>
                      </div>
                      <span className={`px-3 py-1 rounded-full text-sm font-semibold status-${token.status}`}>
                        {token.status.toUpperCase()}
                      </span>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                      <div>
                        <p className="text-gray-600">Queue #</p>
                        <p className="font-bold text-gray-800">{token.queuePosition}</p>
                      </div>
                      <div>
                        <p className="text-gray-600">Quantity</p>
                        <p className="font-bold text-gray-800">{token.quantity} kg</p>
                      </div>
                      <div>
                        <p className="text-gray-600">Mango Type</p>
                        <p className="font-bold text-gray-800">{token.mangoType}</p>
                      </div>
                      <div>
                        <p className="text-gray-600">Est. Time</p>
                        <p className="font-bold text-gray-800">{token.estimatedTime}</p>
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-2">
                      {token.status === 'pending' && (
                        <>
                          <button
                            onClick={() => handleUpdateStatus(token.id, 'approved')}
                            className="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition"
                          >
                            ‚úì Approve
                          </button>
                          <button
                            onClick={() => handleUpdateStatus(token.id, 'rejected')}
                            className="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition"
                          >
                            ‚úó Reject
                          </button>
                        </>
                      )}
                      {token.status === 'approved' && (
                        <button
                          onClick={() => handleUpdateStatus(token.id, 'completed')}
                          className="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition"
                        >
                          Mark as Completed
                        </button>
                      )}
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      );
    }

    // ==================== ADMIN DASHBOARD ====================

    function AdminDashboard({ user, userData }) {
      const [activeTab, setActiveTab] = useState('factories');
      const [loading, setLoading] = useState(false);
      const [permIssue, setPermIssue] = useState(false);

      useEffect(() => {
        verifyPermissions();
      }, []);

      const verifyPermissions = async () => {
        try {
          const userDoc = await window.firebaseUtils.getDoc(
            window.firebaseUtils.doc(window.firebaseDb, 'users', user.uid)
          );
          if (!userDoc.exists() || userDoc.data().role !== 'admin') {
            setPermIssue(true);
          }
        } catch (err) {
          setPermIssue(true);
        }
      };

      const fixPermissions = async () => {
        setLoading(true);
        try {
          await window.firebaseUtils.setDoc(
            window.firebaseUtils.doc(window.firebaseDb, 'users', user.uid),
            {
              name: userData?.name || 'Admin',
              role: 'admin',
              phoneNumber: user.phoneNumber || '+910000000000',
              createdAt: window.firebaseUtils.Timestamp.now()
            },
            { merge: true }
          );
          setPermIssue(false);
          alert('Permissions fixed! You can now manage factories.');
        } catch (err) {
          alert('Failed to fix permissions: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleLogout = async () => {
        await window.firebaseUtils.signOut(window.firebaseAuth);
        window.location.reload();
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50">
          <header className="bg-white shadow-md sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <div>
                <h1 className="text-xl font-bold text-gray-800">Admin Dashboard</h1>
                <p className="text-sm text-gray-600">Full System Control</p>
              </div>
              <div className="flex items-center gap-4">
                {permIssue && (
                  <button
                    onClick={fixPermissions}
                    disabled={loading}
                    className="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-600 transition animate-pulse"
                  >
                    ‚ö†Ô∏è Fix Permissions
                  </button>
                )}
                <button
                  onClick={handleLogout}
                  className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition"
                >
                  Logout
                </button>
              </div>
            </div>
          </header>

          <div className="max-w-7xl mx-auto px-4 py-6">
            <div className="flex gap-2 mb-6">
              <button
                onClick={() => setActiveTab('factories')}
                className={`px-6 py-3 rounded-lg font-semibold transition ${activeTab === 'factories'
                  ? 'bg-purple-600 text-white'
                  : 'bg-white text-gray-700 hover:bg-gray-50'
                  }`}
              >
                Factories
              </button>
              <button
                onClick={() => setActiveTab('users')}
                className={`px-6 py-3 rounded-lg font-semibold transition ${activeTab === 'users'
                  ? 'bg-purple-600 text-white'
                  : 'bg-white text-gray-700 hover:bg-gray-50'
                  }`}
              >
                Users
              </button>
              <button
                onClick={() => setActiveTab('tokens')}
                className={`px-6 py-3 rounded-lg font-semibold transition ${activeTab === 'tokens'
                  ? 'bg-purple-600 text-white'
                  : 'bg-white text-gray-700 hover:bg-gray-50'
                  }`}
              >
                All Tokens
              </button>
            </div>

            {activeTab === 'factories' && <FactoriesAdmin />}
            {activeTab === 'users' && <UsersAdmin />}
            {activeTab === 'tokens' && <TokensAdmin />}
          </div>
        </div>
      );
    }

    // Factories Admin Component
    function FactoriesAdmin() {
      const [factories, setFactories] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [editingFactory, setEditingFactory] = useState(null);
      const [formData, setFormData] = useState({
        name: '',
        address: '',
        lat: '',
        lng: '',
        dailyCapacity: '',
        contactNumber: '',
        openingTime: '08:00',
        closingTime: '18:00',
        isActive: true
      });

      useEffect(() => {
        loadFactories();
      }, []);

      const loadFactories = async () => {
        try {
          const snapshot = await window.firebaseUtils.getDocs(
            window.firebaseUtils.collection(window.firebaseDb, 'factories')
          );
          setFactories(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        } catch (err) {
          console.error('Load Factories Error:', err);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        try {
          const factoryData = {
            ...formData,
            location: {
              lat: parseFloat(formData.lat),
              lng: parseFloat(formData.lng)
            },
            dailyCapacity: parseInt(formData.dailyCapacity),
            createdAt: window.firebaseUtils.Timestamp.now()
          };

          if (editingFactory) {
            await window.firebaseUtils.updateDoc(
              window.firebaseUtils.doc(window.firebaseDb, 'factories', editingFactory.id),
              factoryData
            );
          } else {
            await window.firebaseUtils.addDoc(
              window.firebaseUtils.collection(window.firebaseDb, 'factories'),
              factoryData
            );
          }

          setShowForm(false);
          setEditingFactory(null);
          setFormData({
            name: '',
            address: '',
            lat: '',
            lng: '',
            dailyCapacity: '',
            contactNumber: '',
            openingTime: '08:00',
            closingTime: '18:00',
            isActive: true
          });
          loadFactories();
        } catch (err) {
          console.error('Save Factory Error:', err);
          alert('Failed to save factory');
        }
      };

      const handleEdit = (factory) => {
        setEditingFactory(factory);
        setFormData({
          name: factory.name,
          address: factory.address,
          lat: factory.location.lat,
          lng: factory.location.lng,
          dailyCapacity: factory.dailyCapacity,
          contactNumber: factory.contactNumber,
          openingTime: factory.openingTime,
          closingTime: factory.closingTime,
          isActive: factory.isActive
        });
        setShowForm(true);
      };

      const handleDelete = async (id) => {
        if (confirm('Are you sure you want to delete this factory?')) {
          try {
            await window.firebaseUtils.deleteDoc(
              window.firebaseUtils.doc(window.firebaseDb, 'factories', id)
            );
            loadFactories();
          } catch (err) {
            console.error('Delete Factory Error:', err);
          }
        }
      };

      if (showForm) {
        return (
          <div className="bg-white rounded-xl shadow-md p-6 animate-slideUp">
            <h2 className="text-2xl font-bold mb-6">
              {editingFactory ? 'Edit Factory' : 'Add New Factory'}
            </h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-gray-700 font-medium mb-2">Factory Name</label>
                <input
                  type="text"
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-700 font-medium mb-2">Address</label>
                <textarea
                  value={formData.address}
                  onChange={(e) => setFormData({ ...formData, address: e.target.value })}
                  className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                  rows="3"
                  required
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-gray-700 font-medium mb-2">Latitude</label>
                  <input
                    type="number"
                    step="any"
                    value={formData.lat}
                    onChange={(e) => setFormData({ ...formData, lat: e.target.value })}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-gray-700 font-medium mb-2">Longitude</label>
                  <input
                    type="number"
                    step="any"
                    value={formData.lng}
                    onChange={(e) => setFormData({ ...formData, lng: e.target.value })}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                    required
                  />
                </div>
              </div>
              <div>
                <label className="block text-gray-700 font-medium mb-2">Daily Capacity</label>
                <input
                  type="number"
                  value={formData.dailyCapacity}
                  onChange={(e) => setFormData({ ...formData, dailyCapacity: e.target.value })}
                  className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-700 font-medium mb-2">Contact Number</label>
                <input
                  type="tel"
                  value={formData.contactNumber}
                  onChange={(e) => setFormData({ ...formData, contactNumber: e.target.value })}
                  className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                  required
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-gray-700 font-medium mb-2">Opening Time</label>
                  <input
                    type="time"
                    value={formData.openingTime}
                    onChange={(e) => setFormData({ ...formData, openingTime: e.target.value })}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                    required
                  />
                </div>
                <div>
                  <label className="block text-gray-700 font-medium mb-2">Closing Time</label>
                  <input
                    type="time"
                    value={formData.closingTime}
                    onChange={(e) => setFormData({ ...formData, closingTime: e.target.value })}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500"
                    required
                  />
                </div>
              </div>
              <div className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={formData.isActive}
                  onChange={(e) => setFormData({ ...formData, isActive: e.target.checked })}
                  className="w-5 h-5"
                />
                <label className="text-gray-700 font-medium">Active</label>
              </div>
              <div className="flex gap-2">
                <button
                  type="submit"
                  className="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700"
                >
                  {editingFactory ? 'Update Factory' : 'Add Factory'}
                </button>
                <button
                  type="button"
                  onClick={() => {
                    setShowForm(false);
                    setEditingFactory(null);
                  }}
                  className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        );
      }

      return (
        <div>
          <button
            onClick={() => setShowForm(true)}
            className="mb-6 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700"
          >
            + Add New Factory
          </button>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {factories.map(factory => (
              <div key={factory.id} className="bg-white rounded-xl shadow-md p-6">
                <div className="flex justify-between items-start mb-4">
                  <h3 className="text-xl font-bold text-gray-800">{factory.name}</h3>
                  <span className={`px-3 py-1 rounded-full text-sm ${factory.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }`}>
                    {factory.isActive ? 'Active' : 'Inactive'}
                  </span>
                </div>
                <p className="text-sm text-gray-600 mb-4">{factory.address}</p>
                <div className="flex gap-2">
                  <button
                    onClick={() => handleEdit(factory)}
                    className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
                  >
                    Edit
                  </button>
                  <button
                    onClick={() => handleDelete(factory.id)}
                    className="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600"
                  >
                    Delete
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // Users Admin (placeholder)
    function UsersAdmin() {
      return (
        <div className="bg-white rounded-xl shadow-md p-12 text-center">
          <h2 className="text-2xl font-bold mb-4">User Management</h2>
          <p className="text-gray-600">View and manage all system users here.</p>
        </div>
      );
    }

    // Tokens Admin (placeholder)
    function TokensAdmin() {
      return (
        <div className="bg-white rounded-xl shadow-md p-12 text-center">
          <h2 className="text-2xl font-bold mb-4">All Tokens</h2>
          <p className="text-gray-600">View all tokens across all factories here.</p>
        </div>
      );
    }

    // ==================== MAIN APP COMPONENT ====================

    function App() {
      const [user, setUser] = useState(null);
      const [userData, setUserData] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const initAuth = () => {
          return window.firebaseUtils.onAuthStateChanged(
            window.firebaseAuth,
            async (authUser) => {
              if (authUser) {
                const userDoc = await window.firebaseUtils.getDoc(
                  window.firebaseUtils.doc(window.firebaseDb, 'users', authUser.uid)
                );
                setUser(authUser);
                setUserData(userDoc.exists() ? userDoc.data() : null);
              } else {
                setUser(null);
                setUserData(null);
              }
              setLoading(false);
            }
          );
        };

        let unsubscribe;
        if (window.firebaseUtils) {
          unsubscribe = initAuth();
        } else {
          window.addEventListener('firebase-ready', () => {
            unsubscribe = initAuth();
          });
        }
        return () => unsubscribe && unsubscribe();
      }, []);

      const handleLoginSuccess = (authUser, data) => {
        setUser(authUser);
        setUserData(data);
      };

      const handleRegistrationComplete = (data) => {
        setUserData(data);
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="animate-pulse text-mango-500 text-6xl mb-4">ü•≠</div>
              <p className="text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      if (!user) {
        return <LoginScreen onLoginSuccess={handleLoginSuccess} />;
      }

      if (!userData) {
        return (
          <RegistrationScreen
            user={user}
            onRegistrationComplete={handleRegistrationComplete}
          />
        );
      }

      // Route based on role
      if (userData.role === 'farmer') {
        return <FarmerDashboard user={user} userData={userData} />;
      }

      if (userData.role === 'factory') {
        return <FactoryDashboard user={user} userData={userData} />;
      }

      if (userData.role === 'admin') {
        return <AdminDashboard user={user} userData={userData} />;
      }

      return (
        <div className="min-h-screen flex items-center justify-center">
          <div className="text-center">
            <p className="text-xl text-gray-600">Unknown role: {userData.role}</p>
          </div>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>

</html>